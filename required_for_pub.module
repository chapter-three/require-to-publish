<?php

/**
 * Implements of hook_help().
 */
function required_for_pub_help($path, $arg) {
  switch ($path) {
    case 'admin/help#required_for_pub':
      return t('Allows forms to be filled without required fields before publishing.');
  }
}

/**
 * Implements hook_field_info_alter(&$info).
 */
function required_for_pub_field_info_alter(&$info) {
  // Add a setting to all field types.
  foreach ($info as $field_type => &$field_type_info) {
  $field_type_info += array('instance_settings' => array());
	$field_type_info['instance_settings'] += array(
      'required_for_pub' => false,
    );
  }
}

/**
 * Implements hook_field_ui_field_edit_form_alter(&$form, &$form_state, $form_id).
 */
function required_for_pub_form_field_ui_field_edit_form_alter(&$form, &$form_state, $form_id) {

  $form['instance']['required']['#access'] = FALSE;  // the 'Require field' form element will be handled by the form element below -- as one of the options.
  
  $DEPRECATEDxxxform['instance']['required_for_pub'] = array(
    '#type' => 'checkbox',
    '#title' => t('Required for publishing'),
    '#description' => t('Allows the form to be saved in unpublished state without entering the required fields.'),
    // REMOVED - '#default_value' => isset($form['#instance']['required_for_pub']) ? $form['#instance']['required_for_pub'] : FALSE,
    '#default_value' => empty($form['#instance']['required_for_pub']) ? 0 : 1,  // new way
    '#weight' => -9,
  );
  
  // user can now choose from 3 options: required, required_for_pub, or not required
  $form['instance']['required_for_pub'] = array(
    '#type' => 'radios',
    '#title' => t('Required for publishing'),
    '#description' => t('Allows the form to be saved in unpublished state without entering the required fields.'),
    '#default_value' => empty($form['#instance']['required_for_pub']) ? NULL : $form['#instance']['required_for_pub'], 
    '#weight' => -9,
    '#options' => array(
      'not_required' => 'Not Required',
      'required' => 'Required field',
      'required_for_pub' => 'Required for publishing',
    ),  
  ); 
  
  $form['#validate'][] = '_required_for_pub_field_settings_validate';
}

/**
 * Custom validation for the field_ui_field_edit_form
 */
function _required_for_pub_field_settings_validate($form, &$form_state) {

  // choice can be  'required' or 'required_for_pub' or 'not_required'
  $choice = $form_state['values']['instance']['required_for_pub'];
  
  switch ($choice) {
    case 'required':
      $form_state['values']['instance']['required'] = 1;
      $form_state['values']['instance']['required_for_pub'] = 'required';
      break;
    case 'required_for_pub':
      $form_state['values']['instance']['required_for_pub'] = 'required_for_pub';
      $form_state['values']['instance']['required'] = 0;
      break;      
    case 'not_required':
      $form_state['values']['instance']['required_for_pub'] = 'not_required';
      $form_state['values']['instance']['required'] = 0;
      break;  
  }
  return TRUE;
}




/**
 * Implements hook_field_attach_form()
 */
function required_for_pub_field_attach_form($entity_type, $entity, &$form, &$form_state, $langcode = NULL, $options = array()) {
  $lang = $form['field_test']['#language'];

  drupal_add_css(drupal_get_path('module', 'required_for_pub') . '/css/required_for_pub.css', array('group' => CSS_DEFAULT, 'every_page' => TRUE));
  
  $form['#validate'][] = 'required_for_pub_form_validate';

  $obj = entity_metadata_wrapper('node', $entity);

  // get all fields in the node form_state
  $fields = $form_state['field'];
  
  $fields_required_for_pub = array();  
  foreach ($fields as $field_name => $arr) {
  
    if (empty($arr[$langcode]['instance']['required_for_pub'])) { // value can be 0 or NULL    
    //if (!isset($arr[$langcode]['instance']['required_for_pub'])) { // value can be 0 or NULL
      continue;
    }
    // debug($arr[$langcode]['instance']['required_for_pub']);
    if ( $arr[$langcode]['instance']['required_for_pub'] == 'required_for_pub' ) {  // create an array of fields where required_for_pub is  TRUE // TODO: no need for an if . already checked by isset 4 lines above
      // debug($field_name);
      $fields_required_for_pub[] = $field_name;   
      
      // SOLUTION 1: using css to add the *
      // add css to the div wrapping the field
      $form[$field_name]['#attributes']['class'][] = 'required-for-pub'; 
      
      
      // SOLUTION 2: - using theme registry alter 
      // debug($form[$field_name][$langcode]);
      $form[$field_name][$langcode]['#theme_required_for_pub']['description_at_top'] = '*Required for content to be published.'; 
      
      //debug($form[$field_name][$langcode]); 
      
     // debug($form[$field_name]['#description']);
      //debug($form[$field_name]); 
    }
    
    
  }
  $form_state['required_for_pub']['#fields'] = $fields_required_for_pub;

}


/**
 * Custom validation for the entity add or edit forms
 */
function required_for_pub_form_validate($form, &$form_state) {

  $status = $form_state['values']['status'];
  $lang = $form_state['values']['language'];  
  $empty_fields = array();

  foreach ($form_state['required_for_pub']['#fields'] as $key => $field_name) {
    if (empty($form_state['values'][$field_name][$lang][0])) {
      $item = $form_state['values'][$field_name][$lang];  // some fields do not use any delta or the 0 offset. example: term reference does not use the 0 offset when the field is empty
    }
    else { 
      $item =  $form_state['values'][$field_name][$lang][0];
    }  

    // get the field info
    $field = field_info_field($field_name);

    // get the module that defined the hook_field_is_empty
    $module = $field['module'];
    
    // get the field type
    $field_type = $field['type'];
    
    // get the function name which is in this format: called module_field_is_empty(), where module is the module that defined the field
    $func = $module.'_field_is_empty';
    
    // special handling for booleans
    // NOTE: the list.module's hook_field_is_empty specifies this: 
    // if (empty($item['value']) && (string) $item['value'] !== '0') { return TRUE; }
    // paramter $item passed is array('value' => 0) -- if user has not clicked the wdiget form
    // which means that the boolean field will always return hook_field_is_empty to be FALSE -- that is, the field contains data. when in fact, it should be treated as EMPTY.
    // hence, we convert the value from 0 to NULL or set $item to NULL
    if ($field_type == 'list_boolean') {
      if ($item['value'] == 0) {
        //$item['value'] = NULL;
        $item = NULL;
      }
    }
    
    // special handling for fields that do no use delta or the 0 offset.
    if (empty($item)) {
      $field_is_empty = TRUE;
    }
    else { 
      $field_is_empty = call_user_func($func, $item, $field);
    }
    
    // TO CHECK if field is empty -- this will account for all field types
    if ($field_is_empty) {
      $empty_fields[] = $field_name;
    }
  }
  
  // the most important validation
  $field_string = "";
  $digit = 1;
  if ($status == 1 && !empty($empty_fields) ) {
    form_set_error('required_for_pub', t('You must do "a" or "b": <p>a. Save this node as DRAFT - by unchecking the publish state.</p> <p>b. Or leave the node as published but FILL UP the fields listed below.</p>'));       

    foreach ($empty_fields as $key => $field_name) {
      $field_string = $field_name;
      form_set_error('required_for_pub'.'_'.$field_name, t('%digit. %field_name', array('%field_name' => $field_string, '%digit' => $digit)));
      $digit = $digit + 1;
    }
    
    return FALSE;
    
  }
  else {
    return TRUE;
  }
  return FALSE;
}




function required_for_pub_theme() {
  return array(
    'required_for_pub' => array(
      'variables' => array('required_for_pub' => NULL, 'element' => null),
    ),
  );
}


function theme_required_for_pub(&$var) {
  //debug($var);
  // $var['required_for_pub'] = '<p>Test789</p>';
  // return '<p>Test456</p>';
}




/**
 * Implements hook_theme_registry_alter().
 */
function required_for_pub_theme_registry_alter(&$theme_registry) {
  // Set our custom function for theming form_element_label.
  // Duplicate the original theme hook, under a new name. This
  // will allow us to 'wrap' the theme function without
  // breaking it.
  $theme_registry['form_element_label_required_for_pub'] = $theme_registry['form_element_label'];

  // Because we don't need to count on drupal to re-load this file
  // we're going to only override the 'function' key
  // and leave the 'theme path' etc. to the core setting
  // to avoid potential problems down the road if
  // core changes.
  
  $theme_registry['form_element_label']['function'] = 'required_for_pub_theme_form_element_label';
  
  //debug($theme_registry['form_element_label']);
}


/**
 * Replacement for core theme_form_element_label function.
 *
 * Prints #description at top of field output.
 * Because of jujitsu happening in FAPI theming/wrapping,
 * ctools and WYSIWYG, we have to jump through some hoops 
 * to pull this off.
 *
 * @param Array $variables
 *   An array containing an element.
 */
function required_for_pub_theme_form_element_label($variables) {
  $desc = '';



  /*
  if (isset($variables['element']['#theme_options']['description at top']) && !empty($variables['element']['#theme_options']['description at top'])) {
    $desc = '<div class="description">' . t($variables['element']['#theme_options']['description at top']) . '</div>';
  }  
  
  */ // orginal
  //debug($variables['element']);
 
  $text_required_for_pub = NULL;
  
  if (isset($variables['element']['#theme_required_for_pub']['description_at_top']) && !empty($variables['element']['#theme_required_for_pub']['description_at_top'])) {
   $text_required_for_pub = '<div class="description">' . t($variables['element']['#theme_required_for_pub']['description_at_top']) . '</div>';
  }
  
  //$text_required_for_pub = '<div class="description">'.'*Required for content to be published.'.'</div>';
  // Pass element through the "real" theme hook.
  return theme('form_element_label_required_for_pub', $variables) . $text_required_for_pub ;
}


/**
 * Implements hook_form_alter().
 */
function required_for_pub_form_alter(&$form, &$form_state, $form_id) {
  //debug($form_state['required_for_pub']['#fields']);
  
  if (empty($form_state['required_for_pub']['#fields'])) {
    return;
  }
  else {
    $field_required_for_pub = $form_state['required_for_pub']['#fields'];
  }
  foreach ($form as $key => $item) {
    //debug($key);
    //debug($item);
    if (is_array($item) && isset($item[LANGUAGE_NONE])) {
      // Put comments above the label for field forms of type 'container'
      // that are specifically configured.
      if (isset($item['#type']) && $item['#type'] == 'container' && isset($item[LANGUAGE_NONE][0])
        && isset($item[LANGUAGE_NONE][0]['#entity_type']) && isset($item[LANGUAGE_NONE][0]['#field_name']) && isset($item[LANGUAGE_NONE][0]['#bundle'])
      ) {
        $entity_type = $item[LANGUAGE_NONE][0]['#entity_type'];
        $field_name = $item[LANGUAGE_NONE][0]['#field_name'];
        //debug($field_name);
        
        if (!in_array($field_name, $field_required_for_pub)) {
          continue;
        }
        
        
        $bundle_name = $item[LANGUAGE_NONE][0]['#bundle'];
        $instance = field_info_instance($entity_type, $field_name, $bundle_name);
        //if (isset($instance['widget']['settings']['label_help_description'])) {
          // Quirks:
          // $form[$key][LANGUAGE_NONE][0]['#theme_options'] has to be set to get
          // this working for textarea fields, and
          // form[$key][LANGUAGE_NONE][0]['value']['#theme_options' has to be set
          // to get this working for one-line text fields.
          $form[$key][LANGUAGE_NONE][0]['#theme_required_for_pub'] = $form[$key][LANGUAGE_NONE][0]['value']['#theme_required_for_pub'] = array(
            'description_at_top' => '*Required for content to be published. test 888',
          );
        //}
      }
      // Move comments to the top for other field forms that
      // are specifically configured.
      elseif (isset($item[LANGUAGE_NONE]['#entity_type']) && isset($item[LANGUAGE_NONE]['#field_name']) && isset($item[LANGUAGE_NONE]['#bundle'])) {
        $entity_type = $item[LANGUAGE_NONE]['#entity_type'];
        $field_name = $item[LANGUAGE_NONE]['#field_name'];
        $bundle_name = $item[LANGUAGE_NONE]['#bundle'];
        $instance = field_info_instance($entity_type, $field_name, $bundle_name);
        if (isset($instance['widget']['settings']['label_help_description'])) {
          //$form[$key][LANGUAGE_NONE]['#theme_options'] = $form[$key][LANGUAGE_NONE]['value']['#theme_options'] = array(
            //'description at top' => $instance['widget']['settings']['label_help_description'],
          //);
          //debug($form[$key][LANGUAGE_NONE]);
          //$form[$key][LANGUAGE_NONE]['#theme_options'] = $form[$key][LANGUAGE_NONE]['value']['#theme_options'] = array(
            //'description at top' => '*Required for content to be published.',
          //); 
          $form[$key][LANGUAGE_NONE]['#theme_required_for_pub'] = $form[$key][LANGUAGE_NONE]['value']['#theme_required_for_pub'] = array(
            'description_at_top' => '*Required for content to be published. test 999',
          );        
        }
      }
    }
  }
}

